!function(t,e){if("object"==typeof exports&&"object"==typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var n=e();for(var r in n)("object"==typeof exports?exports:t)[r]=n[r]}}(self,(function(){return(()=>{"use strict";var t={14:(t,e,n)=>{t.exports=n.p+"83811d7190b85384cff4.js"}},e={};function n(r){var i=e[r];if(void 0!==i)return i.exports;var a=e[r]={exports:{}};return t[r](a,a.exports,n),a.exports}return n.p="/includes/",(()=>{var t,e=n(14),r=function(t,e,n,r){return new(n||(n=Promise))((function(i,a){function o(t){try{u(r.next(t))}catch(t){a(t)}}function s(t){try{u(r.throw(t))}catch(t){a(t)}}function u(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,s)}u((r=r.apply(t,e||[])).next())}))},i=function(t,e){var n,r,i,a,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return a={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(a){return function(s){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(i=2&a[0]?r.return:a[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,a[1])).done)return i;switch(r=0,i&&(a=[2&a[0],i.value]),a[0]){case 0:case 1:i=a;break;case 4:return o.label++,{value:a[1],done:!1};case 5:o.label++,r=a[1],a=[0];continue;case 7:a=o.ops.pop(),o.trys.pop();continue;default:if(!((i=(i=o.trys).length>0&&i[i.length-1])||6!==a[0]&&2!==a[0])){o=0;continue}if(3===a[0]&&(!i||a[1]>i[0]&&a[1]<i[3])){o.label=a[1];break}if(6===a[0]&&o.label<i[1]){o.label=i[1],i=a;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(a);break}i[2]&&o.ops.pop(),o.trys.pop();continue}a=e.call(t,o)}catch(t){a=[6,t],r=0}finally{n=i=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,s])}}},a=function(t,e,n){if(n||2===arguments.length)for(var r,i=0,a=e.length;i<a;i++)!r&&i in e||(r||(r=Array.prototype.slice.call(e,0,i)),r[i]=e[i]);return t.concat(r||Array.prototype.slice.call(e))};function o(t){if(t.startsWith("h264"))return{ffmpegFormat:"mp4",mime:'video/mp4; codecs="avc1.640033'};if(t.startsWith("flac"))return{ffmpegFormat:"mp4",mime:'audio/mp4; codecs="flac"'};if(t.startsWith("mp3"))return{ffmpegFormat:"mp4",mime:'audio/mp4; codecs="mp3"'};if(t.startsWith("vorbis"))return{ffmpegFormat:"webm",mime:'audio/webm; codecs="vorbis"'};if(t.startsWith("aac"))return{ffmpegFormat:"mp4",mime:'audio/mp4; codecs="mp4a.40.2"'};if(t.startsWith("opus"))return{ffmpegFormat:"webm",mime:'audio/webm; codecs="opus"'};throw new Error("Unsupported ffmpeg format description: "+t)}self.importScripts(e),function(t){t[t.Uninitialized=1]="Uninitialized",t[t.Initializing=2]="Initializing",t[t.Idle=3]="Idle",t[t.Busy=4]="Busy"}(t||(t={}));var s=function(){function n(){this.outputDir="/output",this.ffmpegState=t.Uninitialized,this.buf=new Uint8Array}return n.prototype.assertState=function(t){if(this.ffmpegState!=t)throw new Error("Expected state "+t+" but current state is "+this.ffmpegState)},n.prototype.isLoaded=function(){return!(this.ffmpegState==t.Uninitialized)},n.prototype.consumeMetadata=function(){return r(this,void 0,void 0,(function(){var t,e,r,a,o,s,u,c,f,p,l,m;return i(this,(function(i){switch(i.label){case 0:return[4,this.runFFmpeg("-i","input.mkv")];case 1:for(t=i.sent(),console.log(t),this.inputMetadata={durationSeconds:void 0,audioStreams:[],videoStreams:[],subtitleTracks:[],attachments:[]},e=0,r=t;e<r.length;e++)if(a=r[e],(o=a.match(n.durationRegex))&&(this.inputMetadata.durationSeconds=parseFloat(o[3])+60*parseInt(o[2])+3600*parseInt(o[1])),s=n.streamRegex.exec(a))switch(u=s.groups,c=u.id,f=u.lang,p=u.type,l=u.formatDescription,m={id:c,lang:f,formatDescription:l},p){case"Audio":this.inputMetadata.audioStreams.push(m);break;case"Video":this.inputMetadata.videoStreams.push(m);break;case"Subtitle":this.inputMetadata.subtitleTracks.push(m);break;case"Attachment":this.inputMetadata.attachments.push(m);break;default:console.warn("Ignoring non-audio/video stream",p,m)}return[2]}}))}))},n.prototype.reset=function(){return r(this,void 0,void 0,(function(){return i(this,(function(t){return this.buf=new Uint8Array,[2]}))}))},n.prototype.writeData=function(t,e){return r(this,void 0,void 0,(function(){var n;return i(this,(function(r){return e+t.length>this.buf.length&&((n=new Uint8Array(e+t.length)).set(this.buf),this.buf=n),this.buf.set(t,e),[2,this.buf]}))}))},n.prototype.getInputData=function(){return r(this,void 0,void 0,(function(){return i(this,(function(t){return[2,this.buf]}))}))},n.prototype.getMetadata=function(){return r(this,void 0,void 0,(function(){return i(this,(function(t){return[2,this.inputMetadata]}))}))},n.prototype.remuxChunk=function(t,e,n,s){return void 0===t&&(t=0),r(this,void 0,void 0,(function(){var r,u,c,f,p,l,m,d,h,g;return i(this,(function(i){switch(i.label){case 0:if(0==(r=this.inputMetadata.videoStreams.filter((function(t){return t.id==n}))).length)throw Error("No video stream found with id "+n);if(u=r[0],c=o(u.formatDescription),null!=s){if(0==(l=this.inputMetadata.audioStreams.filter((function(t){return t.id==s}))).length)throw Error("No audio stream found with id "+s);f=l[0],p=o(f.formatDescription)}return m=a(a(["-ss",t.toString()],void 0===e||e==t?[]:["-to",e.toString()],!0),["-copyts","-i","input.mkv"],!1),c&&(m=m.concat(["-map",u.id,"-f",c.ffmpegFormat,"-vcodec","copy","-movflags","frag_keyframe+delay_moov+default_base_moof","video"])),p&&(m=m.concat(["-map",f.id,"-strict","-2","-f",p.ffmpegFormat,"-acodec","copy","-movflags","frag_keyframe+delay_moov+default_base_moof","audio"])),[4,this.runFFmpeg.apply(this,m)];case 1:return i.sent(),d=this.ffmpegCore.FS,h=null,g=null,c&&(h={data:d.readFile("video"),mime:c.mime},d.unlink("video")),p&&(g={data:d.readFile("audio"),mime:p.mime},d.unlink("audio")),[2,{audioChunk:g,videoChunk:h}]}}))}))},n.prototype.runFFmpeg=function(){for(var a=[],o=0;o<arguments.length;o++)a[o]=arguments[o];return r(this,void 0,void 0,(function(){var r,o,s,u;return i(this,(function(i){switch(i.label){case 0:r=function(t,e){var n=t._malloc(e.length*Uint32Array.BYTES_PER_ELEMENT);return e.forEach((function(e,r){var i=t.lengthBytesUTF8(e)+1,a=t._malloc(i);t.stringToUTF8(e,a,i),t.setValue(n+Uint32Array.BYTES_PER_ELEMENT*r,a,"i32")})),[e.length,n]},console.log("Running ffmpeg",a),this.ffmpegState=t.Busy,o=[],i.label=1;case 1:return i.trys.push([1,3,,4]),s=this,[4,createFFmpegCore({locateFile:function(t,n){return t.endsWith("ffmpeg-core.wasm")?"/includes/ffmpeg-core.wasm":t.endsWith("ffmpeg-core.worker.js")?e:n+t},printErr:function(t){o.push(t),console.log(t)},print:function(t){console.log(t),o.push(t)}})];case 2:return s.ffmpegCore=i.sent(),this.ffmpegMain=this.ffmpegCore.cwrap("main","number",["number","number"]),this.ffmpegCore.FS.writeFile("input.mkv",this.buf),this.ffmpegMain.apply(this,r(this.ffmpegCore,n.defaultArgs.concat(a))),console.log("end"),[3,4];case 3:return 0==(u=i.sent()).status?this.ffmpegState=t.Idle:console.error("Exception caught from entrypoint: ",u),[3,4];case 4:return[2,o]}}))}))},n.defaultArgs=["ffmpeg","-hide_banner","-nostdin"],n.streamRegex=/\s*Stream #(?<id>\d+:\d+)\(?(?<lang>.*?)\)?: (?<type>\w+): (?<formatDescription>.*)/,n.durationRegex=/Duration: (\d+?):(\d{2}):(.+?),/,n}();const u=s,c=Symbol("Comlink.proxy"),f=Symbol("Comlink.endpoint"),p=Symbol("Comlink.releaseProxy"),l=Symbol("Comlink.thrown"),m=t=>"object"==typeof t&&null!==t||"function"==typeof t,d=new Map([["proxy",{canHandle:t=>m(t)&&t[c],serialize(t){const{port1:e,port2:n}=new MessageChannel;return h(t,e),[n,[n]]},deserialize:t=>(t.start(),y(t,[],undefined))}],["throw",{canHandle:t=>m(t)&&l in t,serialize({value:t}){let e;return e=t instanceof Error?{isError:!0,value:{message:t.message,name:t.name,stack:t.stack}}:{isError:!1,value:t},[e,[]]},deserialize(t){if(t.isError)throw Object.assign(new Error(t.value.message),t.value);throw t.value}}]]);function h(t,e=self){e.addEventListener("message",(function n(r){if(!r||!r.data)return;const{id:i,type:a,path:o}=Object.assign({path:[]},r.data),s=(r.data.argumentList||[]).map(S);let u;try{const e=o.slice(0,-1).reduce(((t,e)=>t[e]),t),n=o.reduce(((t,e)=>t[e]),t);switch(a){case"GET":u=n;break;case"SET":e[o.slice(-1)[0]]=S(r.data.value),u=!0;break;case"APPLY":u=n.apply(e,s);break;case"CONSTRUCT":u=function(t){return Object.assign(t,{[c]:!0})}(new n(...s));break;case"ENDPOINT":{const{port1:e,port2:n}=new MessageChannel;h(t,n),u=function(t,e){return w.set(t,e),t}(e,[e])}break;case"RELEASE":u=void 0;break;default:return}}catch(t){u={value:t,[l]:0}}Promise.resolve(u).catch((t=>({value:t,[l]:0}))).then((t=>{const[r,o]=E(t);e.postMessage(Object.assign(Object.assign({},r),{id:i}),o),"RELEASE"===a&&(e.removeEventListener("message",n),g(e))}))})),e.start&&e.start()}function g(t){(function(t){return"MessagePort"===t.constructor.name})(t)&&t.close()}function v(t){if(t)throw new Error("Proxy has been released and is not useable")}function y(t,e=[],n=function(){}){let r=!1;const i=new Proxy(n,{get(n,a){if(v(r),a===p)return()=>k(t,{type:"RELEASE",path:e.map((t=>t.toString()))}).then((()=>{g(t),r=!0}));if("then"===a){if(0===e.length)return{then:()=>i};const n=k(t,{type:"GET",path:e.map((t=>t.toString()))}).then(S);return n.then.bind(n)}return y(t,[...e,a])},set(n,i,a){v(r);const[o,s]=E(a);return k(t,{type:"SET",path:[...e,i].map((t=>t.toString())),value:o},s).then(S)},apply(n,i,a){v(r);const o=e[e.length-1];if(o===f)return k(t,{type:"ENDPOINT"}).then(S);if("bind"===o)return y(t,e.slice(0,-1));const[s,u]=b(a);return k(t,{type:"APPLY",path:e.map((t=>t.toString())),argumentList:s},u).then(S)},construct(n,i){v(r);const[a,o]=b(i);return k(t,{type:"CONSTRUCT",path:e.map((t=>t.toString())),argumentList:a},o).then(S)}});return i}function b(t){const e=t.map(E);return[e.map((t=>t[0])),(n=e.map((t=>t[1])),Array.prototype.concat.apply([],n))];var n}const w=new WeakMap;function E(t){for(const[e,n]of d)if(n.canHandle(t)){const[r,i]=n.serialize(t);return[{type:"HANDLER",name:e,value:r},i]}return[{type:"RAW",value:t},w.get(t)||[]]}function S(t){switch(t.type){case"HANDLER":return d.get(t.name).deserialize(t.value);case"RAW":return t.value}}function k(t,e,n){return new Promise((r=>{const i=new Array(4).fill(0).map((()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16))).join("-");t.addEventListener("message",(function e(n){n.data&&n.data.id&&n.data.id===i&&(t.removeEventListener("message",e),r(n.data))})),t.start&&t.start(),t.postMessage(Object.assign({id:i},e),n)}))}h(new u)})(),{}})()}));
//# sourceMappingURL=182.js.map